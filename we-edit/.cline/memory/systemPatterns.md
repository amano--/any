# システムパターン

## アーキテクチャパターン

### レイヤードアーキテクチャ

1. プレゼンテーション層

   - Next.js App Router
   - shadcn/uiコンポーネント
   - Zustand状態管理

2. APIレイヤー

   - tRPCルーター
   - 型安全なエンドポイント
   - バリデーション

3. データアクセス層
   - Repositoryパターン
   - Drizzle ORM
   - マイグレーション管理

## デザインパターン

### コンポーネント設計

1. Atomic Design

   - TreeContainer (Container)
   - TreeItem (Presentational)
   - 共通スタイル定義

2. Adapterパターン

   - Chrome互換データ変換
   - API通信抽象化

3. Repository
   - データアクセスの抽象化
   - テスト容易性の向上

### コンポーネント初期化パターン

1. 遅延初期化

   - useEffectによる安全な初期化
   - SSRとの互換性確保
   - 依存関係の最適化

2. デフォルト状態管理

   - ルートフォルダの自動作成
   - 多言語対応の初期値
   - 状態の永続化

3. エラーハンドリング
   - 初期化失敗時のフォールバック
   - 重複防止メカニズム
   - ユーザーへのフィードバック

### 多言語対応パターン

1. リソース分離

   - 言語ごとのファイル分割
   - 階層化された翻訳キー
   - 型安全なアクセス

2. フォールバック

   - デフォルト言語設定
   - 未翻訳時の代替テキスト
   - エラーハンドリング

3. 動的ローディング
   - 言語リソースの遅延読み込み
   - キャッシュ戦略
   - バンドルサイズ最適化

## データモデリング

### 階層構造

1. Adjacency List

   - parent_id参照
   - position順序付け
   - 深さ制限

2. ルートフォルダ管理

   - 自動初期化ロジック
   - 一意性の保証
   - 多言語名の管理

3. バリデーション
   - 循環参照チェック
   - 重複名防止
   - 最大深さ制限

## 状態管理

### Zustandパターン

1. グローバル状態

   - ツリー構造
   - 選択状態
   - UI状態
   - 言語設定

2. 永続化
   - ローカルストレージ
   - セッション管理
   - 言語設定の保存

## テストパターン

### テスト戦略

1. ユニットテスト

   - コンポーネント単体
   - ユーティリティ関数
   - バリデーション

2. インテグレーション

   - APIエンドポイント
   - データフロー
   - 状態管理

3. UI/UXテスト
   - Storybookシナリオ
   - インタラクション
   - アクセシビリティ
   - 多言語表示

## イベントソーシングパターン

### イベント定義

1. 構造化イベント
   - 判別可能なUnion型による型定義
   - 機能ごとの分離されたイベント定義
   - ULIDによるイベントID

2. イベントの分類
   - Write Events（状態変更）
   - Read Events（状態参照）
   - イベントストアでの分離管理

3. 保守性と拡張性
   - 機能ディレクトリ内でのイベント定義
   - コアモジュールでのイベント集約
   - 型安全性の確保

## エラー処理パターン

### Result型パターン

1. 型安全なエラーハンドリング
   - neverthrowパッケージの活用
   - エラー型の具体化
   - 早期リターンパターン

2. エラーフロー制御
   - map/mapErrによる変換
   - chainによる連鎖
   - matchによる分岐処理

3. エラー型設計
   - タグ付きUnion型
   - コンテキスト固有のエラー定義
   - 集約エラー処理

## セキュリティパターン

### 認証・認可

1. NextAuth

   - セッション管理
   - ルート保護
   - API認証

2. バリデーション
   - 入力検証
   - APIペイロード
   - クロスサイトスクリプティング対策

## 最適化パターン

### パフォーマンス

1. キャッシング

   - APIレスポンス
   - 静的アセット
   - 状態永続化
   - 言語リソース

2. レンダリング
   - 仮想化リスト
   - 遅延ロード
   - メモ化
   - 翻訳の最適化

## AI開発支援パターン

### 実装計画パターン

1. ドキュメント構造化

   - 実装計画テンプレート活用
   - 関連ドキュメントのリンク管理
   - バージョン履歴の追跡

2. タスク分割
   - 機能単位の分割
   - 依存関係の明確化
   - 優先順位付け

### コード管理パターン

1. AI決定記録

   - 実装アプローチの選択理由
   - 代替案の検討プロセス
   - 将来の拡張性考慮

2. コメント構造化
   - 標準化されたタグ使用（@ai_decision, @ai_implementation）
   - アルゴリズムの説明
   - パフォーマンス考慮点の記録

### 品質管理パターン

1. レビュープロセス

   - AI実装計画との整合性確認
   - セキュリティ要件の検証
   - パフォーマンス要件の確認

2. 技術的負債管理
   - 負債の特定と記録
   - 優先順位付けと対応計画
   - 定期的な見直し

### 継続的改善パターン

1. フィードバックループ

   - 実装後のレビュー
   - パフォーマンス計測
   - 改善提案の収集

2. ナレッジベース更新
   - 共通課題のパターン化
   - ベストプラクティスの更新
   - チーム間知見共有
